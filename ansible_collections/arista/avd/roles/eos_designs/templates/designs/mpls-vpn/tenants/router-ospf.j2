{# Rendering tenant OSPF #}
{% for tenant in switch.tenants | arista.avd.natural_sort %}
{%     for vrf in tenants[tenant].vrfs | arista.avd.natural_sort %}
{%         if tenants[tenant].vrfs[vrf].ospf.enabled is arista.avd.defined(true) %}
{%             if tenants[tenant].vrfs[vrf].ospf.nodes is defined and inventory_hostname in tenants[tenant].vrfs[vrf].ospf.nodes %}
{%                 set vrf_ospf_interfaces = [] %}
{#                 if this ospf process ID clashes with underlay process ID, you're gonna have a bad time. #}
{%                 set ospf_process_id = tenants[tenant].vrfs[vrf].ospf.process_id |Â arista.avd.default(tenants[tenant].vrfs[vrf].vrf_rt) %}
{%                 set ospf_router_id = tenants[tenant].vrfs[vrf].ospf.router_id | arista.avd.default(switch.router_id) %}
{%                 set ospf_address_families = tenants[tenant].vrfs[vrf].ospf.address_families | arista.avd.default(["ipv4"]) %}
{%                 for l3_interface in tenants[tenant].vrfs[vrf].l3_interfaces | arista.avd.default([]) %}
{%                     if l3_interface.nodes is arista.avd.defined and inventory_hostname in l3_interface.nodes and l3_interface.ip_addresses is arista.avd.defined and l3_interface.interfaces is arista.avd.defined %}
{%                         for node in l3_interface.nodes %}
{%                             if node == inventory_hostname %}
{%                                 if l3_interface.ospf.enabled is arista.avd.defined(true) %}
{%                                     do vrf_ospf_interfaces.append(l3_interface.interfaces[loop.index0]) %}
{%                                 endif %}
{%                             endif %}
{%                         endfor %}
{%                     endif %}
{%                 endfor %}
{%                 if "ipv4" in ospf_address_families %}
router_ospf:
  process_ids:
    {{ ospf_process_id }}:
      vrf: {{ vrf }}
      passive_interface_default: true
      router_id: {{ ospf_router_id }}
      no_passive_interfaces:
{%                 for l3_interface in vrf_ospf_interfaces | arista.avd.natural_sort %}
{# L3 P2P interfaces #}
        - {{ l3_interface }}
{%                 endfor %}
{%                 if switch.tenants[tenant].vrfs[vrf].ospf.bfd is arista.avd.defined(true) %}
      bfd_enable: true
{%                 endif %}
{%                 if switch.tenants[tenant].vrfs[vrf].ospf.max_lsa is arista.avd.defined() %}
      max_lsa: {{ switch.tenants[tenant].vrfs[vrf].ospf.max_lsa }}
{%                 endif %}
      redistribute:
{%                 if switch.tenants[tenant].vrfs[vrf].ospf.redistribute_bgp is not arista.avd.defined %}
      bgp: true
{%                 elif switch.tenants[tenant].vrfs[vrf].ospf.redistribute_bgp.route_map is arista.avd.defined %}
      bgp:
        route_map: {{ switch.tenants[tenant].vrfs[vrf].ospf.redistribute_bgp.route_map }}
{%                 elif switch.tenants[tenant].vrfs[vrf].ospf.redistribute_bgp is not arista.avd.defined(false) %}
      bgp: true
{%                 endif %}
{%             endif %}
{%         endif %}
{# {%             if "ipv6" in ospf_address_families %} #}
{#                 do ospfv3 stuff, doesn't exist in cli_config_gen yet. #}
{# {%             endif %} #}
{%         endif %}
{%     endfor %}
{% endfor %}